## Installing Vagrant & Setting Up Infrastructure
For the lab, we'll use Vagrant and quickly setup our environment for analysis.
[Vagrant](https://www.vagrantup.com/) is a utility for managing Virtual Machines. You can find the installer's for your Operating System [here](https://www.vagrantup.com/downloads). Vagrant makes it easy to create repeatable virtual machine environments, and we'll be using it for this course to provision a Ubuntu 20.10 Virtual Machine as our analysis machine. The particular box we're using is defined as ```config.vm.box``` .

```sh
  config.vm.box = "generic/ubuntu2010"
```


In the code block below the "libvirt" vm provider is specified to spin up a Virtual Machine. If you're using Virtualbox, you should change this to, you guessed it "virtualbox". Vagrant supports numerous other providers which can be found in their official documentation [here](https://www.vagrantup.com/docs/providers). Below the provider statement we're allocating 4GB of RAM for our virtual machine and the provider to virtualbox.

```sh
   #config.vm.provider "libvirt" do |vb|
   config.vm.provider "virtualbox" do |vb|
     vb.memory = "4096"
   end
```


Two Vagrant files exist. One that leverages Ansible and another that just executes shell commands.
If you do not have ansible installed for your Operating System, you can keep things simple by leveraging the "[shell](https://www.vagrantup.com/docs/provisioning/shell)" provisioner. This provisioner executes the commands listed within the *shell* variables in the Virtual machine. Numerous providers exist to provision virtual machines (Ansible, Chef, etc...). If you **do** have Ansible installed, move onto the next section!

```sh
   config.vm.provision "shell", inline: <<-SHELL
     apt-get update -y;
     apt-get install -y radare2 git tmux vim;
   SHELL
```

## Ansible & Vagrant
The provision block of the Vagrant file specifies to use the Ansible provisioner.
This lets the end user make Ansible Playbooks to install and configure virtual machines automatically when Vagrants are launched.
```
   config.vm.provision "ansible" do |ansible|
    ansible.verbose = "v"
    ansible.playbook = "playbook.yml"
   end
```

Lets examine the playbook.yml file by executing ```cat playbook.yml```.
``` sh
- hosts: all
  become: true
  roles:
   - roles/setupvm
```

The role "setupvm" contains a subfolder called "tasks." This contains a series of tasks to be executed in the Vagrant VM.
``` sh
---
- name: Install Packages for Malware Analysis
  apt:
    name: "{{ item }}" # item will be substituted with any word in the loop directive below.
    update_cache: yes # this is equivalent to apt-get update
  loop:
    - vim
    - tmux
    - radare2
    - python3
    - python3-pip
    - yara
    - unzip
```

Feel free to add tools to this to enable your malware VM to have the tools you want it to have!
Look at ```./roles/setupvm/tasks/main.yml``` to see the packages that provision the target host..

## Starting Vagrant!
After making any modifications that you might have (provider/RAM/etc...), go forth and sping up your virtual machine! To start your VM, simply execute

``` sh
vagrant up
```

If the Vagrant virutal machine "generic/ubuntu2004" has not been downloaded, it'll take a second to download prior to executing the provision commands. However, afterwards it'll execute much faster. To check on the status of your virtual machine, execute "vagrant status". You should see something like the code block below showing that it's successfully running. Note, yours may say Virtualbox and not libvirt.

``` sh

☁  00_Setup [main] ⚡  vagrant status
Current machine states:

default                   running (libvirt)

The Libvirt domain ()is running. To stop this machine, you can run
`vagrant halt`. To destroy the machine, you can run `vagrant destroy`.
```

## Accessing your virtual machine.
We'll access the virtual machine via vagrant's built in-ssh command.
Vagrant leverages a private key it stores in "~/.vagrant.d/insecure_private_key" to perform ssh based authentication.

``` sh
vagrant ssh
```

If successful, you should find yourself with shell access to the vagrant machine and can now access the lab machine that will be used for the course.

```
☁  00_Setup [main] ⚡  vagrant ssh
Last login: Tue Feb 15 23:56:12 2022 from 192.168.121.1
vagrant@bsidesroc:~$ id
uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant),4(adm),24(cdrom),30(dip),46(plugdev),111(lxd),117(lpadmin),118(sambashare)
vagrant@bsidesroc:~$ 
```

## Stopping the Virtual Machine
To shut off the virtual machine you can execute "halt"
```sh
vagrant halt
```

## Destroying the Virtual Machine
When you're done, you can "clean up" by deleting the virtual machine via:
```sh
vagrant destroy
```

## Beyond The Class
* Add to ```./roles/tasks/main.yml``` additional packages you're interested in.
