## Automating Collection - Malshare Account
Before we can automate downloading daily dumps from Malshare, we need to create an account.
1. Go to [malshare.com](https://malshare.com/)
2. Click on [register](https://malshare.com/register.php)
3. Enter a name, and e-mail address.
4. Get your official API key to interact with the API service.

## Building Your Own Download Tool
The Malshare API is [well documented](https://malshare.com/doc.php) and easy to implement in a variety of languages.
Arch Cloud Labs has a tool that leverages multiple malware provider's APIs called [mquery](https://github.com/archcloudlabs/mquery).
For the sake of this lab we'll build a simple download utility in Python to continue with our focus on building multiple-skillsets.

If we're running short on time, feel free to use the ```malshare_download.py``` script provided for you!
Just update the ```config.ini``` file with your malshare API key.


### Copying files into the running Vagrant machine
To copy the script into the Vagrant machine you can either leverage the Vagrant upload command or scp (secure copy). 
The output below shows the vagrant upload command. You have to be in the same folder as your ```Vagrantfile```.

```
➜  00_Setup git:(main) ✗ vagrant upload ../01_Automating_Collection/malshare_download.py
Uploading ../01_Automating_Collection/malshare_download.py to malshare_download.py
Upload has completed successfully!
```

To leverage scp, execute the command below and replace ```vagrant_ip_goes_here``` with the IP address of your Vagrant machine.
To get the IP address of your Vagrant machine, execute ```ifconfig``` from a command shell within Vagrant.

``` sh
$> scp malshare_download.py vagrant@vagrant_ip_goes_here: 
```

## Getting The Latest Hashes
The following code block will show how to fetch the latest hashes in Python.
Feel free to try on your own before looking at the provided annotated solution.

<details><summary> Python Example for Querying API </summary>

``` sh
#!/usr/bin/env python3
import sys
import configparser
import json

try:
    import requests
except ImportError as err:
    print(f"error: {err}")
    sys.exit(1)

config = configparser.ConfigParser()
config.read("config.ini")  # config file that contains API keys
apikey = config.get("DEFAULT", "MALSHARE_API")

LATEST_SAMPLES_URL = "https://www.malshare.com/api.php?api_key=API_KEY&action=getlist".replace("API_KEY", apikey) # URL for upstream Malshare API


def get_latest_hashes(hashAlgo="sha1"):
    """
    Grab the latest hashes (md5/sha1/sha256) from the Malshare API.

    hashAlgo: string value to indiciate the hash algorithm to use.
    return: List of hashes
    """
    latest_hashes = []
    req = requests.get(LATEST_SAMPLES_URL)
    if req.status_code == 200:
        data = json.loads(req.content)
        [latest_hashes.append((sample.get(hashAlgo))) for sample in data]
    return latest_hashes


if __name__ == "__main__":

    hashes = get_latest_hashes()
    print(hashes) # print list of hashes
```
</details>


### Getting The Latest Samples
Now that we have a list of the latest hashes, we can start to download them!
The Malshare API endpoin looks as follows

``` sh

https://www.malshare.com/api.php?api_key=API_KEY_GOES_HERE&action=getfile&hash=MALWARE_HASH_GOES_HERE

```
Take a stab at developing it, before taking a look below!

<details>

``` sh

def download_sample(listOfSamples: list):
    """
    Download a sample from malshare based on hash

    return: byte array to write to file
    """
    if listOfSamples is None:
        logging.error("No samples to download")
        return None

    __create_path__(path="./malware")

    for sample in listOfSamples:
        sample_url = DOWNLOAD_SAMPLE_URL.replace("MAL_HASH", sample)
        logging.info(f"Downloading: {sample}")
        try:
            req = requests.get(sample_url)
            if req.status_code == 200:
                #data = __inline_patch__(req.content)  # optional
                with open(f"./malware/{sample}", "wb") as fout:
                    fout.write(req.content)
        except requests.ConnectionError as conn_error:
            logging.error(f"Trouble making request to {sample_url} - {conn_error}")
            pass

        except requests.ConnectTimeout as conn_error:
            logging.error(f"Trouble making request to {sample_url} - {conn_error}")
            pass

```

</details>

## Automating the Collection
Combining both of these functions we can get and download daily samples.
Not all samples are PEs and ELFs however. There could be GIFs/JPEGs/XLS/Docs/etc... being uploaded.
Consider how you would filter that out as a "beyond the course" objective.
A list of "magic bytes" can be found on [Wikipedia here](https://en.wikipedia.org/wiki/List_of_file_signatures).

Next, we'll simply run our code to grab the hashes and save the samples to disk.
Again, if we're running short on time, feel free to use the ```malshare_download.py``` script provided for you!
You can always come back and create a new tool later!

## Beyond The Course
The provided code was *very* minimal, but it accomplished the goal.
Here are some additional tasks to consider beyond the course to further build Software Development skills:
  * What if you wanted to schedule this script to run every day? How would you do it?
  * How could the script be modified to download malware samples in parallel?
  * What about running this in a Kubernetes cluster? (*Checkout Minikube to run something locally*)
  * How can we add a "saftey header" to prevent accidental execution?
    * What would we have to do with our tools during analysis?
