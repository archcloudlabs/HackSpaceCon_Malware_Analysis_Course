## Public Feeds

With Elasticsearch up and running, we'll start exploring downloading and ingesting some public feeds.
Specifically we'll start with Hybrid-Analysis. Hybrid-Analysis provides a lot of fields to parse.
In this example we'll only parse a handful to get started, and leave more for after the class.

## Getting Started with Hybrid-Analysis

Hybrid-Analysis is a VirusTotal competitor that publishes a public feed at "https://hybrid-analysis.com/feed?json".
This feed contains data from publicly submitted URLs and binaries. Best of all, no authentication required!
Data includes:
* Domains queried.
* processes spawned.
* files dropped.
* A **boat load** more.

The portion of this lab is to expose you to Hybrid-Analysis as a data source to draw in forensic artifacts from.

<details><summary> Python Example for Querying API </summary>

``` python
#!/usr/bin/env python3
import sys
import json
from dataclasses import dataclass
try:
    import requests
except ImportError as err:
    print(f"Error import {err}")
    sys.exit(1)

url = "https://hybrid-analysis.com/feed?json"

@dataclass
class malwareStruct:
    md5: str
    sha1: str
    sha256: str
    tags: str
    domains: list
    process_list: str
    threatscore: int
    vt: int
    ms: int


def pulsedive(ip):
    """
    query an IP address against pulse dives IP

    returns JSON string
    """
    req = requests.get(f"https://pulsedive.com/api/explore.php?q={ip}")
    if req.status_code == 200:
        return (json.loads(req.content))


def process_data(data):
    """
    get data from hybrid-analysis public feed and then enrich/parse it.
    data: JSON blob of data from hybrid-analysis

    return: None
    """
    for entry in data.get('data'):
        malObj = malwareStruct

        malObj.md5 = entry.get('md5')
        malObj.sha256 = entry.get('sha256')
        malObj.tags = entry.get('tags')
        malObj.domains = entry.get('domains')
        malObj.process_list = entry.get('process_list')
        malObj.threatscore = entry.get('threatscore')
        malObj.vt = entry.get('vt_detect')
        malObj.ms = entry.get('ms_detect')
        malObj.ips = entry.get('hosts')

        __printer_helper__(malObj)

       #if ips is not None:
       #    [print(pulsedive(ip)) for ip in ips]

def __printer_helper__(malObj):
    """
    Helper function to print dataclass
    """
    print(f"{malObj.md5}, {malObj.domains}, {malObj.ips}, {malObj.threatscore}")

if __name__ == "__main__":

    headers = {"User-Agent": "Arch Cloud Labs"}
    req = requests.get(url, headers=headers)
    if req.status_code == 200:
        data = json.loads(req.content)
        process_data(data)
    else:
        print(f"Error making request - status code: f{req.status_code}")
        sys.exit(1)
```

</details>

## Enriching Data w/ Free Providers
[GreyNoise](https://www.greynoise.io/), [Pulse Dive](https://pulsedive.com/), and [IPInfo](https://ipinfo.io/) are all data providers that have a free tier for independent researchers at the time of this workshop. The data they provide are complimentary to each other, and I encourage you to explore all of them to understand their use cases. 

* [GreyNoise](https://www.greynoise.io): Provides insight into what's just noise on the internet vs mass exploitation attempts, and things to pay attention to.
  * *Note, limited free number of API requests a day.*

* [Pulse Dive](https://pulsedive.com): CTI provider providing historical context around a given IP address/domain, and geo location.

* [IP Info](https://ipinfo.com): Geo provider for IP addresses.
  * *Note, requires free signup for an API key.*

Given the data we just fetched from Hybrid-Analysis, let's enrich some of the IP data with historic threat intel data!
First, we'll modify the code above to enrich the IP from PulseDive. Pulse dive provides some historical data, classification (malicious/threat actor) and geo location.

<summary> Python Example for PulseDive API </summary>

``` python
def pulsedive(ip):
    req = requests.get(f"https://pulsedive.com/api/explore.php?q={ip}")
    if req.status_code == 200:
        print(json.loads(req.content))
```


Next, let's further enrich this with Grey Noise!

<summary> Python Example for GreyNoise API </summary>

``` python

def pulsedive(ip):
    req = requests.get(f"https://api.greynoise.io/v3/community/{ip}")
    if req.status_code == 200:
        print(json.loads(req.content))
```

An example output can be seen below. You may notice an interesting tag of "riot".
Per [GreyNoise's documentation](https://docs.greynoise.io/docs/riot-data), riot is:
> a new GreyNoise feature that informs users about IPs used by common business services that are almost certainly not attacking you

This is a great feature of GreyNoise's API to help filter out IPs that are just noise.

``` bash
{'ip': '142.250.189.161', 'noise': False, 'riot': True, 'classification': 'benign', 'name': 'Google APIs and Services', 'link': 'https://viz.greynoise.io/riot/142.250.189.161', 'last_seen': '2023-04-11', 'message': 'Success'}
2fb8d55e61a21e32fd228023748e614f, ['static.axept.io', 't4523b89a.emailsys1c.net', 'www.googleadservices.com', 'www.gstatic.com', 'www.rapidmail.de'], ['185.71.125.3', '142.250.72.195', '142.250.189.162', '13.227.74.3'], 26
None
{'ip': '142.250.72.195', 'noise': False, 'riot': True, 'classification': 'benign', 'name': 'Google APIs and Services', 'link': 'https://viz.greynoise.io/riot/142.250.72.195', 'last_seen': '2023-04-11', 'message': 'Success'}
{'ip': '142.250.189.162', 'noise': False, 'riot': True, 'classification': 'benign', 'name': 'Google APIs and Services', 'link': 'https://viz.greynoise.io/riot/142.250.189.162', 'last_seen': '2023-04-11', 'message': 'Success'}
{

```

</details>

Congrats on making it to this point! You've completed the course, and I hope you enjoyed it!
Want to let me know something? Open an issue, and please share with your friends if this helped!

## Beyond The Class

* Update the previous code to pull out additional fields you're interested in to ingest into Elasticsearch.
* Explore Alien Vault's Open Threat Exchange API for pulling in threat data of interest to you!
* Up until this point we've been doing "ad-hoc" Python scripts for the course, go back and integrate the scripts into a larger application!
